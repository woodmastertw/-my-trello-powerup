<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Trello Ê®ôÊ∫ñÂ∑•ÊôÇË®≠ÂÆö</title>
    <!-- ÂºïÂÖ• Trello Power-Up Client Library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 12px;
            background-color: #F4F5F7;
        }
        label {
            font-weight: 600;
            color: #172B4D;
            display: block;
            margin-bottom: 4px;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            box-sizing: border-box;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #0079BF;
        }
        button {
            background-color: #0079BF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #02609F;
        }
    </style>
</head>
<body>
    <!-- ÈÄôÈÉ®ÂàÜÊòØÂΩàÂá∫Ë¶ñÁ™óÁöÑÂÖßÂÆπ -->
    <div id="popup-content">
        <label for="workHours">Ë´ãËº∏ÂÖ•Ê®ôÊ∫ñÂ∑•ÊôÇ (Â∞èÊôÇ):</label>
        <input type="number" id="workHours" min="0" step="0.5" placeholder="‰æãÂ¶Ç: 8">
        <button id="saveButton">ÂÑ≤Â≠ò</button>
    </div>

    <script>
        // --- PART 1: POWER-UP INITIALIZATION ---
        var CLOCK_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xvY2siPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIj48L2NpcmNsZT48cG9seWxpbmUgcG9pbnRzPSIxMiA2IDEyIDEyIDE2IDE0Ij48L3BvbHlsaW5lPjwvc3ZnPg==';

        TrelloPowerUp.initialize({
            'card-buttons': function (t, options) {
                return [{
                    icon: CLOCK_ICON,
                    text: 'Ë®≠ÂÆöÊ®ôÊ∫ñÂ∑•ÊôÇ',
                    callback: function (t) {
                        return t.popup({
                            title: 'Ë®≠ÂÆöÊ®ôÊ∫ñÂ∑•ÊôÇ',
                            url: window.location.href,
                            height: 184
                        });
                    }
                }];
            },
            'card-badges': function (t, options) {
                return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                text: `üïì ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            },
            'card-detail-badges': function (t, options) {
                 return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                title: 'Ê®ôÊ∫ñÂ∑•ÊôÇ',
                                text: `üïì ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            }
        });

        // --- PART 2: POPUP LOGIC (ÊúÄÁµÇ‰øÆÊ≠£Áâà) ---
        var t_iframe = TrelloPowerUp.iframe();

        t_iframe.render(function(){
            // Áï∂ÂΩàÂá∫Ë¶ñÁ™óËºâÂÖ•‰∏î Trello iframe Ê∫ñÂÇôÂ∞±Á∑íÊôÇÔºåÂü∑Ë°åÊâÄÊúâÁõ∏ÈóúË®≠ÂÆö
            console.log("Power-Up popup is rendering...");

            // 1. ÂÖàÂæû Trello ÂèñÂæóÂ∑≤ÂÑ≤Â≠òÁöÑÂ∑•ÊôÇ
            return t_iframe.get('card', 'shared', 'workHours')
                .then(function(hours){
                    console.log("Fetched existing hours:", hours);
                    // 2. Â∞áÂ∑•ÊôÇÂ°´ÂÖ•Ëº∏ÂÖ•Ê°Ü
                    document.getElementById('workHours').value = hours || '';
                })
                .then(function(){
                    // 3. ‚òÖ‚òÖ‚òÖ ‰øÆÊ≠£ÈªûÔºöÁ¢∫‰øù DOM ÈÉΩÂ∑≤ËºâÂÖ•‰∏îÊï∏ÂÄºÂ∑≤Â°´ÂÖ•ÂæåÔºåÊâçÁ∂ÅÂÆö‰∫ã‰ª∂ ‚òÖ‚òÖ‚òÖ
                    console.log("DOM is ready, attaching save button listener.");
                    document.getElementById('saveButton').addEventListener('click', function(){
                        console.log("Save button clicked!");
                        var hoursInput = document.getElementById('workHours').value;
                        var hours = parseFloat(hoursInput);
                        var valueToStore = (hoursInput !== '' && !isNaN(hours) && hours >= 0) ? hours : null;
                        
                        console.log("Attempting to store value:", valueToStore);
                        return t_iframe.set('card', 'shared', 'workHours', valueToStore)
                            .then(function(){
                                console.log("Value stored successfully. Closing popup.");
                                t_iframe.closePopup();
                            });
                    });

                    // 4. ÊúÄÂæåÂÜçË™øÊï¥Ë¶ñÁ™óÂ§ßÂ∞è
                    t_iframe.sizeTo('body').done();
                });
        });

    </script>
</body>
</html>

