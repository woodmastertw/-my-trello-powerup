<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Trello 標準工時設定</title>
    <!-- 引入 Trello Power-Up Client Library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 12px;
            background-color: #F4F5F7;
        }
        label {
            font-weight: 600;
            color: #172B4D;
            display: block;
            margin-bottom: 4px;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            box-sizing: border-box;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #0079BF;
        }
        button {
            background-color: #0079BF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #02609F;
        }
    </style>
</head>
<body>
    <!-- 這部分是彈出視窗的內容 -->
    <div id="popup-content">
        <label for="workHours">請輸入標準工時 (小時):</label>
        <input type="number" id="workHours" min="0" step="0.5" placeholder="例如: 8">
        <button id="saveButton">儲存</button>
    </div>

    <script>
        // --- PART 1: POWER-UP INITIALIZATION ---
        // 這部分程式碼會在 Trello 背景載入，告訴 Trello 這個 Power-Up 有哪些功能。

        var CLOCK_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xvY2siPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIj48L2NpcmNsZT48cG9seWxpbmUgcG9pbnRzPSIxMiA2IDEyIDEyIDE2IDE0Ij48L3BvbHlsaW5lPjwvc3ZnPg==';

        TrelloPowerUp.initialize({
            'card-buttons': function (t, options) {
                return [{
                    icon: CLOCK_ICON,
                    text: '設定標準工時',
                    callback: function (t) {
                        return t.popup({
                            title: '設定標準工時',
                            url: window.location.href,
                            height: 184
                        });
                    }
                }];
            },
            'card-badges': function (t, options) {
                return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                text: `🕓 ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            },
            'card-detail-badges': function (t, options) {
                 return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                title: '標準工時',
                                text: `🕓 ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            }
        });

        // --- PART 2: POPUP LOGIC (修正後) ---
        // 這部分程式碼只會在彈出視窗 (iframe) 中執行。
        var t_iframe = TrelloPowerUp.iframe();

        // 當彈出視窗載入且 Trello iframe 準備就緒時，執行所有相關設定
        t_iframe.render(function(){
            
            // 將事件監聽器綁定在 render 函數內，確保 t_iframe 已準備好
            document.getElementById('saveButton').addEventListener('click', function(){
                var hoursInput = document.getElementById('workHours').value;
                var hours = parseFloat(hoursInput);

                // 確保儲存的是有效的數字，否則儲存 null 來清除
                var valueToStore = (hoursInput !== '' && !isNaN(hours) && hours >= 0) ? hours : null;
                
                return t_iframe.set('card', 'shared', 'workHours', valueToStore)
                    .then(function(){
                        // 儲存成功後關閉彈出視窗
                        t_iframe.closePopup();
                    });
            });

            // 自動填入已儲存的工時
            return t_iframe.get('card', 'shared', 'workHours')
                .then(function(hours){
                    // 使用 hours || '' 避免在輸入框中顯示 'null'
                    document.getElementById('workHours').value = hours || '';
                })
                .then(function(){
                    // 讓 Trello 自動調整彈出視窗的高度以符合內容
                    t_iframe.sizeTo('body').done();
                });
        });

    </script>
</body>
</html>

