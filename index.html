<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Trello æ¨™æº–å·¥æ™‚è¨­å®š</title>
    <!-- å¼•å…¥ Trello Power-Up Client Library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 12px;
            background-color: #F4F5F7;
        }
        label {
            font-weight: 600;
            color: #172B4D;
            display: block;
            margin-bottom: 4px;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            box-sizing: border-box;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #0079BF;
        }
        button {
            background-color: #0079BF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #02609F;
        }
    </style>
</head>
<body>
    <!-- é€™éƒ¨åˆ†æ˜¯å½ˆå‡ºè¦–çª—çš„å…§å®¹ -->
    <div id="popup-content">
        <label for="workHours">è«‹è¼¸å…¥æ¨™æº–å·¥æ™‚ (å°æ™‚):</label>
        <input type="number" id="workHours" min="0" step="0.5" placeholder="ä¾‹å¦‚: 8">
        <button id="saveButton">å„²å­˜</button>
    </div>

    <script>
        // --- PART 1: POWER-UP INITIALIZATION ---
        // é€™éƒ¨åˆ†ç¨‹å¼ç¢¼æœƒåœ¨ Trello èƒŒæ™¯è¼‰å…¥ï¼Œå‘Šè¨´ Trello é€™å€‹ Power-Up æœ‰å“ªäº›åŠŸèƒ½ã€‚

        var CLOCK_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xvY2siPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIj48L2NpcmNsZT48cG9seWxpbmUgcG9pbnRzPSIxMiA2IDEyIDEyIDE2IDE0Ij48L3BvbHlsaW5lPjwvc3ZnPg==';

        TrelloPowerUp.initialize({
            'card-buttons': function (t, options) {
                return [{
                    icon: CLOCK_ICON,
                    text: 'è¨­å®šæ¨™æº–å·¥æ™‚',
                    callback: function (t) {
                        return t.popup({
                            title: 'è¨­å®šæ¨™æº–å·¥æ™‚',
                            url: window.location.href,
                            height: 184
                        });
                    }
                }];
            },
            'card-badges': function (t, options) {
                return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                text: `ğŸ•“ ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            },
            'card-detail-badges': function (t, options) {
                 return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                title: 'æ¨™æº–å·¥æ™‚',
                                text: `ğŸ•“ ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            }
        });

        // --- PART 2: POPUP LOGIC (ä¿®æ­£å¾Œ) ---
        // é€™éƒ¨åˆ†ç¨‹å¼ç¢¼åªæœƒåœ¨å½ˆå‡ºè¦–çª— (iframe) ä¸­åŸ·è¡Œã€‚
        var t_iframe = TrelloPowerUp.iframe();

        // ç•¶å½ˆå‡ºè¦–çª—è¼‰å…¥ä¸” Trello iframe æº–å‚™å°±ç·’æ™‚ï¼ŒåŸ·è¡Œæ‰€æœ‰ç›¸é—œè¨­å®š
        t_iframe.render(function(){
            
            // å°‡äº‹ä»¶ç›£è½å™¨ç¶å®šåœ¨ render å‡½æ•¸å…§ï¼Œç¢ºä¿ t_iframe å·²æº–å‚™å¥½
            document.getElementById('saveButton').addEventListener('click', function(){
                var hoursInput = document.getElementById('workHours').value;
                var hours = parseFloat(hoursInput);

                // ç¢ºä¿å„²å­˜çš„æ˜¯æœ‰æ•ˆçš„æ•¸å­—ï¼Œå¦å‰‡å„²å­˜ null ä¾†æ¸…é™¤
                var valueToStore = (hoursInput !== '' && !isNaN(hours) && hours >= 0) ? hours : null;
                
                return t_iframe.set('card', 'shared', 'workHours', valueToStore)
                    .then(function(){
                        // å„²å­˜æˆåŠŸå¾Œé—œé–‰å½ˆå‡ºè¦–çª—
                        t_iframe.closePopup();
                    });
            });

            // è‡ªå‹•å¡«å…¥å·²å„²å­˜çš„å·¥æ™‚
            return t_iframe.get('card', 'shared', 'workHours')
                .then(function(hours){
                    // ä½¿ç”¨ hours || '' é¿å…åœ¨è¼¸å…¥æ¡†ä¸­é¡¯ç¤º 'null'
                    document.getElementById('workHours').value = hours || '';
                })
                .then(function(){
                    // è®“ Trello è‡ªå‹•èª¿æ•´å½ˆå‡ºè¦–çª—çš„é«˜åº¦ä»¥ç¬¦åˆå…§å®¹
                    t_iframe.sizeTo('body').done();
                });
        });

    </script>
</body>
</html>

