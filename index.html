<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Trello æ¨™æº–å·¥æ™‚è¨­å®š</title>
    <!-- å¼•å…¥ Trello Power-Up Client Library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 12px;
            background-color: #F4F5F7;
        }
        label {
            font-weight: 600;
            color: #172B4D;
            display: block;
            margin-bottom: 4px;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            box-sizing: border-box;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #0079BF;
        }
        button {
            background-color: #0079BF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #02609F;
        }
    </style>
</head>
<body>
    <!-- é€™éƒ¨åˆ†æ˜¯å½ˆå‡ºè¦–çª—çš„å…§å®¹ -->
    <div id="popup-content">
        <label for="workHours">è«‹è¼¸å…¥æ¨™æº–å·¥æ™‚ (å°æ™‚):</label>
        <input type="number" id="workHours" min="0" step="0.5" placeholder="ä¾‹å¦‚: 8">
        <button id="saveButton">å„²å­˜</button>
    </div>

    <script>
        var CLOCK_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xvY2siPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIj48L2NpcmNsZT48cG9seWxpbmUgcG9pbnRzPSIxMiA2IDEyIDEyIDE2IDE0Ij48L3BvbHlsaW5lPjwvc3ZnPg==';

        // --- PART 1: POWER-UP INITIALIZATION ---
        // é€™éƒ¨åˆ†ç¨‹å¼ç¢¼æœƒåœ¨ Trello èƒŒæ™¯åŸ·è¡Œï¼Œå‘Šè¨´ Trello é€™å€‹ Power-Up æœ‰å“ªäº›åŠŸèƒ½ã€‚
        TrelloPowerUp.initialize({
            'card-buttons': function (t, options) {
                return [{
                    icon: CLOCK_ICON,
                    text: 'è¨­å®šæ¨™æº–å·¥æ™‚',
                    callback: function (t) {
                        return t.popup({
                            title: 'è¨­å®šæ¨™æº–å·¥æ™‚',
                            url: window.location.href, // å½ˆå‡ºè¦–çª—æœƒå†æ¬¡è¼‰å…¥é€™å€‹ HTML æª”æ¡ˆ
                            height: 184
                        });
                    }
                }];
            },
            'card-badges': function (t, options) {
                return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                text: `ğŸ•“ ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            },
            'card-detail-badges': function (t, options) {
                 return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                title: 'æ¨™æº–å·¥æ™‚',
                                text: `ğŸ•“ ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            }
        });

        // --- PART 2: POPUP LOGIC (æœ€ç©©å®šç‰ˆæœ¬) ---
        // ç‚ºäº†é¿å…åœ¨èƒŒæ™¯åŸ·è¡Œæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œæˆ‘å€‘åªåœ¨ç¢ºå®š DOM å…ƒç´ å­˜åœ¨æ™‚æ‰åŸ·è¡Œå½ˆå‡ºè¦–çª—çš„é‚è¼¯ã€‚
        if (window.TrelloPowerUp && window.TrelloPowerUp.iframe) {
            var t_iframe = window.TrelloPowerUp.iframe();

            t_iframe.render(function(){
                // 1. å…ˆå¾ Trello å–å¾—å·²å„²å­˜çš„å·¥æ™‚
                return t_iframe.get('card', 'shared', 'workHours')
                    .then(function(hours){
                        // 2. å°‡å·¥æ™‚å¡«å…¥è¼¸å…¥æ¡†
                        document.getElementById('workHours').value = hours || '';
                    })
                    .then(function(){
                        // 3. ç¢ºä¿ DOM éƒ½å·²è¼‰å…¥ä¸”æ•¸å€¼å·²å¡«å…¥å¾Œï¼Œæ‰ç¶å®šäº‹ä»¶
                        document.getElementById('saveButton').addEventListener('click', function(){
                            var hoursInput = document.getElementById('workHours').value;
                            var hours = parseFloat(hoursInput);
                            var valueToStore = (hoursInput !== '' && !isNaN(hours) && hours >= 0) ? hours : null;
                            
                            return t_iframe.set('card', 'shared', 'workHours', valueToStore)
                                .then(function(){
                                    t_iframe.closePopup();
                                });
                        });

                        // 4. æœ€å¾Œå†èª¿æ•´è¦–çª—å¤§å°
                        t_iframe.sizeTo('body').done();
                    });
            });
        }
    </script>
</body>
</html>

