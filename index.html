<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Trello 標準工時設定</title>
    <!-- 引入 Trello Power-Up Client Library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            margin: 0;
            padding: 12px;
            background-color: #F4F5F7;
        }
        label {
            font-weight: 600;
            color: #172B4D;
            display: block;
            margin-bottom: 4px;
        }
        input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            box-sizing: border-box;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #0079BF;
        }
        button {
            background-color: #0079BF;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 10px 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #02609F;
        }
    </style>
</head>
<body>
    <!-- 這部分是彈出視窗的內容 -->
    <div id="popup-content">
        <label for="workHours">請輸入標準工時 (小時):</label>
        <input type="number" id="workHours" min="0" step="0.5" placeholder="例如: 8">
        <button id="saveButton">儲存</button>
    </div>

    <script>
        var CLOCK_ICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJmZWF0aGVyIGZlYXRoZXItY2xvY2siPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjEwIj48L2NpcmNsZT48cG9seWxpbmUgcG9pbnRzPSIxMiA2IDEyIDEyIDE2IDE0Ij48L3BvbHlsaW5lPjwvc3ZnPg==';

        // --- PART 1: POWER-UP INITIALIZATION ---
        // 這部分程式碼會在 Trello 背景執行，告訴 Trello 這個 Power-Up 有哪些功能。
        TrelloPowerUp.initialize({
            'card-buttons': function (t, options) {
                return [{
                    icon: CLOCK_ICON,
                    text: '設定標準工時',
                    callback: function (t) {
                        return t.popup({
                            title: '設定標準工時',
                            url: window.location.href, // 彈出視窗會再次載入這個 HTML 檔案
                            height: 184
                        });
                    }
                }];
            },
            'card-badges': function (t, options) {
                return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                text: `🕓 ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            },
            'card-detail-badges': function (t, options) {
                 return t.get('card', 'shared', 'workHours')
                    .then(function (hours) {
                        if (hours && parseFloat(hours) > 0) {
                            return [{
                                title: '標準工時',
                                text: `🕓 ${parseFloat(hours)}h`,
                                color: 'blue'
                            }];
                        }
                        return [];
                    });
            }
        });

        // --- PART 2: POPUP LOGIC (最穩定版本) ---
        // 為了避免在背景執行時發生錯誤，我們只在確定 DOM 元素存在時才執行彈出視窗的邏輯。
        if (window.TrelloPowerUp && window.TrelloPowerUp.iframe) {
            var t_iframe = window.TrelloPowerUp.iframe();

            t_iframe.render(function(){
                // 1. 先從 Trello 取得已儲存的工時
                return t_iframe.get('card', 'shared', 'workHours')
                    .then(function(hours){
                        // 2. 將工時填入輸入框
                        document.getElementById('workHours').value = hours || '';
                    })
                    .then(function(){
                        // 3. 確保 DOM 都已載入且數值已填入後，才綁定事件
                        document.getElementById('saveButton').addEventListener('click', function(){
                            var hoursInput = document.getElementById('workHours').value;
                            var hours = parseFloat(hoursInput);
                            var valueToStore = (hoursInput !== '' && !isNaN(hours) && hours >= 0) ? hours : null;
                            
                            return t_iframe.set('card', 'shared', 'workHours', valueToStore)
                                .then(function(){
                                    t_iframe.closePopup();
                                });
                        });

                        // 4. 最後再調整視窗大小
                        t_iframe.sizeTo('body').done();
                    });
            });
        }
    </script>
</body>
</html>

